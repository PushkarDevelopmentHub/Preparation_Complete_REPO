name: Auto PR & Merge to DEV

on:
  schedule:
    - cron: '20 6 * * *'
    - cron: '20 18 * * *'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-pr-merge:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install GitHub CLI
        run: |
          sudo apt update
          sudo apt install gh -y
          sudo apt install jq -y

      - name: Authenticate GH CLI
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh auth status

      - name: Create & Merge PRs into DEV
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -eo pipefail

          DEV_BRANCH="DEV"

          TOTAL_BRANCHES=0
          TOTAL_PRS_CREATED=0
          TOTAL_MERGED=0
          TOTAL_CONFLICTS=0
          CONFLICT_LIST=""

          git fetch --all --prune

          # Get all remote branches except DEV & main
          branches=$(git branch -r \
            | grep 'origin/' \
            | sed 's|origin/||' \
            | grep -vE "^(HEAD|main|$DEV_BRANCH)$")

          for branch in $branches; do
            echo "üîç Checking branch: $branch"

            # Check commits ahead of DEV
            COMMITS=$(git rev-list --count origin/$DEV_BRANCH..origin/$branch 2>/dev/null || echo 0)

            if [ "$COMMITS" -eq 0 ]; then
              echo "‚û°Ô∏è No commits ahead of DEV"
              continue
            fi

            TOTAL_BRANCHES=$((TOTAL_BRANCHES + 1))

            # Check if PR already exists
            PR_NUMBER=$(gh pr list \
              --base "$DEV_BRANCH" \
              --head "$branch" \
              --state open \
              --json number \
              --jq '.[0].number' || true)

            # Create PR if not exists
            if [ -z "$PR_NUMBER" ]; then
              echo "üÜï Creating PR: $DEV_BRANCH <- $branch"

              gh pr create \
                -B "$DEV_BRANCH" \
                -H "$branch" \
                -t "Auto PR: $branch ‚Üí $DEV_BRANCH" \
                -b "Automated PR from GitHub Actions" \
                || true

              sleep 3

              PR_NUMBER=$(gh pr list \
                --base "$DEV_BRANCH" \
                --head "$branch" \
                --state open \
                --json number \
                --jq '.[0].number')

              TOTAL_PRS_CREATED=$((TOTAL_PRS_CREATED + 1))
            fi

            echo "‚è≥ Checking mergeability for PR #$PR_NUMBER"
            sleep 5

            PR_INFO=$(gh pr view "$PR_NUMBER" --json mergeable,mergeStateStatus)

            MERGEABLE=$(echo "$PR_INFO" | jq -r '.mergeable')
            MERGE_STATE=$(echo "$PR_INFO" | jq -r '.mergeStateStatus')

            # Merge if clean
            if [[ "$MERGEABLE" == "MERGEABLE" && "$MERGE_STATE" == "CLEAN" ]]; then
              echo "‚úÖ Merging PR #$PR_NUMBER"

              gh pr merge "$PR_NUMBER" --merge --delete-branch
              TOTAL_MERGED=$((TOTAL_MERGED + 1))

            else
              echo "‚ö†Ô∏è Conflict in PR #$PR_NUMBER from branch $branch"

              TOTAL_CONFLICTS=$((TOTAL_CONFLICTS + 1))
              CONFLICT_LIST="$CONFLICT_LIST PR#$PR_NUMBER($branch)"
            fi

          done

          echo ""
          echo "================ SUMMARY ================"
          echo "Branches with commits : $TOTAL_BRANCHES"
          echo "PRs created          : $TOTAL_PRS_CREATED"
          echo "PRs merged           : $TOTAL_MERGED"
          echo "PRs with conflicts   : $TOTAL_CONFLICTS"

          if [ ! -z "$CONFLICT_LIST" ]; then
            echo "Conflict PRs         : $CONFLICT_LIST"
          fi

          echo "========================================"
