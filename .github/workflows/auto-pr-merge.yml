name: Auto PR & Merge to DEV

on:
  schedule:
    - cron: '20 6 * * *'
    - cron: '20 18 * * *'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-pr-merge:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install GitHub CLI
        run: |
          sudo apt update
          sudo apt install gh -y

      - name: Authenticate GH CLI
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh auth status

      - name: Create & Merge PRs into DEV
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e

          DEV_BRANCH="DEV"

          TOTAL_BRANCHES=0
          TOTAL_PRS_CREATED=0
          TOTAL_MERGED=0
          TOTAL_CONFLICTS=0

          git fetch --all --prune

          branches=$(git for-each-ref --format='%(refname)' refs/remotes/origin/ \
            | grep '^refs/remotes/origin/' \
            | sed 's|refs/remotes/origin/||' \
            | grep -v '/' \
            | grep -vE "^(HEAD|main|$DEV_BRANCH)$")


          for branch in $branches; do
            echo "üîç Checking branch: $branch"

            COMMITS=$(git log origin/$DEV_BRANCH..origin/$branch --oneline || true)
            [ -z "$COMMITS" ] && echo "‚û°Ô∏è No commits ahead of DEV" && continue

            TOTAL_BRANCHES=$((TOTAL_BRANCHES + 1))

            PR_NUMBER=$(gh pr list \
              --base "$DEV_BRANCH" \
              --head "$branch" \
              --state open \
              --json number \
              --jq '.[0].number')

            if [ -z "$PR_NUMBER" ]; then
              echo "üÜï Creating PR: $DEV_BRANCH <- $branch"

              PR_NUMBER=$(gh pr create \
                --base "$DEV_BRANCH" \
                --head "$branch" \
                --title "Auto PR: $branch ‚Üí $DEV_BRANCH" \
                --body "Automated PR from GitHub Actions" \
                --json number \
                --jq '.number')

              TOTAL_PRS_CREATED=$((TOTAL_PRS_CREATED + 1))
            fi

            echo "‚è≥ Waiting for GitHub to compute mergeability..."
            sleep 5

            PR_INFO=$(gh pr view "$PR_NUMBER" --json mergeable,mergeStateStatus)

            MERGEABLE=$(echo "$PR_INFO" | jq -r '.mergeable')
            MERGE_STATE=$(echo "$PR_INFO" | jq -r '.mergeStateStatus')

            if [[ "$MERGEABLE" == "MERGEABLE" && "$MERGE_STATE" == "CLEAN" ]]; then
              echo "‚úÖ No conflicts ‚Äî merging PR #$PR_NUMBER"

              gh pr merge "$PR_NUMBER" --merge --delete-branch
              TOTAL_MERGED=$((TOTAL_MERGED + 1))
            else
              echo "‚ö†Ô∏è Conflict detected in PR #$PR_NUMBER"
              TOTAL_CONFLICTS=$((TOTAL_CONFLICTS + 1))
            fi
          done

          echo ""
          echo "================ SUMMARY ================"
          echo "Branches with commits : $TOTAL_BRANCHES"
          echo "PRs created          : $TOTAL_PRS_CREATED"
          echo "PRs merged           : $TOTAL_MERGED"
          echo "PRs with conflicts   : $TOTAL_CONFLICTS"
          echo "========================================"
